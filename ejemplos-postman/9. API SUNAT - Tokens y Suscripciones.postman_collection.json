{
	"info": {
		"_postman_id": "tokens-suscripciones-2025-01-15",
		"name": "9. API SUNAT - Tokens y Suscripciones",
		"description": "Colecci√≥n completa para gestionar tokens de API por empresa y suscripciones/licencias.\n\nüîë **TOKENS DE EMPRESA:**\n- Crear tokens de API para integraciones\n- Listar y gestionar tokens\n- Regenerar y revocar tokens\n- Usar tokens para consumir el API\n\nüí≥ **SUSCRIPCIONES:**\n- Crear y gestionar suscripciones\n- Configurar l√≠mites (documentos, ventas, usuarios)\n- Activar, cancelar y renovar suscripciones\n- Verificar estado de suscripciones\n\nüìä **L√çMITES AUTOM√ÅTICOS:**\n- L√≠mite mensual de documentos\n- L√≠mite total de documentos\n- L√≠mite total de monto de ventas\n- Verificaci√≥n autom√°tica antes de crear documentos\n\n‚ö° **CREACI√ìN AUTOM√ÅTICA:**\n- Al crear una empresa, se genera autom√°ticamente un token principal\n- El token est√° listo para usar inmediatamente\n\n**Variables requeridas (compartidas con otras colecciones):**\n- base_url: URL base de la API\n- company_id: ID de la empresa\n- user_token o access_token: Bearer token de autenticaci√≥n de usuario (para gestionar tokens/suscripciones)\n- company_token: Token de empresa (para usar el API directamente)\n\n**Variables compartidas:** Esta colecci√≥n usa las mismas variables que la colecci√≥n principal para facilitar las pruebas.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "TOKENS DE EMPRESA",
			"item": [
				{
					"name": "1.1 - Listar Tokens de una Empresa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens"
							]
						},
						"description": "Lista todos los tokens de API de una empresa. Requiere autenticaci√≥n de usuario."
					},
					"response": []
				},
				{
					"name": "1.2 - Crear Token de API",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 201) {",
									"    const jsonData = pm.response.json();",
									"    if (jsonData.token && jsonData.token.token) {",
									"        pm.collectionVariables.set('company_token', jsonData.token.token);",
									"        console.log('‚úÖ Token de empresa guardado: ' + jsonData.token.token.substring(0, 20) + '...');",
									"        console.log('‚ö†Ô∏è IMPORTANTE: Guarda este token de forma segura. No se mostrar√° nuevamente.');",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"name\": \"Token para integraci√≥n ERP\",\n    \"abilities\": [\"*\"],\n    \"expires_at\": \"2025-12-31 23:59:59\",\n    \"allowed_ips\": [\"192.168.1.100\"],\n    \"max_requests_per_day\": 10000,\n    \"max_requests_per_minute\": 100\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens"
							]
						},
						"description": "Crea un nuevo token de API para la empresa. El token se guarda autom√°ticamente en la variable 'company_token'.\n\n**Par√°metros opcionales:**\n- abilities: Array de permisos (ej: [\"invoices.create\", \"boletas.view\"]) o [\"*\"] para todos\n- expires_at: Fecha de expiraci√≥n (formato: YYYY-MM-DD HH:MM:SS)\n- allowed_ips: Array de IPs permitidas (ej: [\"192.168.1.100\", \"10.0.0.0/8\"])\n- max_requests_per_day: L√≠mite de solicitudes por d√≠a\n- max_requests_per_minute: L√≠mite de solicitudes por minuto"
					},
					"response": []
				},
				{
					"name": "1.3 - Ver Token Espec√≠fico",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens/1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens",
								"1"
							]
						},
						"description": "Obtiene informaci√≥n detallada de un token espec√≠fico. Reemplaza '1' con el ID del token."
					},
					"response": []
				},
				{
					"name": "1.4 - Actualizar Token",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"name\": \"Token actualizado\",\n    \"is_active\": true,\n    \"abilities\": [\"invoices.create\", \"invoices.view\"],\n    \"expires_at\": \"2026-12-31 23:59:59\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens/1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens",
								"1"
							]
						},
						"description": "Actualiza un token existente. Reemplaza '1' con el ID del token."
					},
					"response": []
				},
				{
					"name": "1.5 - Regenerar Token",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"if (pm.response.code === 200) {",
									"    const jsonData = pm.response.json();",
									"    if (jsonData.token && jsonData.token.token) {",
									"        pm.collectionVariables.set('company_token', jsonData.token.token);",
									"        console.log('‚úÖ Nuevo token regenerado y guardado');",
									"        console.log('‚ö†Ô∏è El token anterior ha sido revocado');",
									"    }",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens/1/regenerate",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens",
								"1",
								"regenerate"
							]
						},
						"description": "Regenera un token (crea uno nuevo y revoca el anterior). El nuevo token se guarda autom√°ticamente."
					},
					"response": []
				},
				{
					"name": "1.6 - Revocar Token",
					"request": {
						"method": "DELETE",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/tokens/1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"tokens",
								"1"
							]
						},
						"description": "Revoca (desactiva) un token. Reemplaza '1' con el ID del token."
					},
					"response": []
				},
				{
					"name": "1.7 - Usar Token de Empresa (Obtener Info)",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{company_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/company/info",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"company",
								"info"
							]
						},
						"description": "Ejemplo de uso del token de empresa para consumir el API. Usa el token en lugar del token de usuario.\n\n**Nota:** Tambi√©n puedes usar el header 'X-API-Key' en lugar de 'Authorization: Bearer'"
					},
					"response": []
				}
			],
			"description": "Gesti√≥n completa de tokens de API por empresa. Los tokens permiten a las empresas consumir el API directamente sin autenticaci√≥n de usuario."
		},
		{
			"name": "SUSCRIPCIONES",
			"item": [
				{
					"name": "2.1 - Listar Suscripciones de una Empresa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions"
							]
						},
						"description": "Lista todas las suscripciones de una empresa."
					},
					"response": []
				},
				{
					"name": "2.2 - Ver Suscripci√≥n Activa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/active",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"active"
							]
						},
						"description": "Obtiene la suscripci√≥n activa de la empresa, si existe."
					},
					"response": []
				},
				{
					"name": "2.3 - Crear Suscripci√≥n (Solo Super Admin)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"plan_name\": \"premium\",\n    \"plan_type\": \"monthly\",\n    \"price\": 299.00,\n    \"currency\": \"PEN\",\n    \"starts_at\": \"2025-01-15 00:00:00\",\n    \"ends_at\": \"2025-02-15 23:59:59\",\n    \"max_documents_per_month\": 10000,\n    \"max_total_documents\": 50000,\n    \"max_total_sales_amount\": 1000000.00,\n    \"max_users\": 5,\n    \"max_branches\": 3,\n    \"features\": [\"api_access\", \"priority_support\", \"custom_integrations\"],\n    \"payment_method\": \"stripe\",\n    \"payment_reference\": \"ch_1234567890\",\n    \"cancel_previous\": true\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions"
							]
						},
						"description": "Crea una nueva suscripci√≥n para la empresa. Solo super administradores pueden crear suscripciones.\n\n**L√≠mites configurables:**\n- max_documents_per_month: L√≠mite mensual (null = ilimitado)\n- max_total_documents: L√≠mite total desde inicio (null = ilimitado)\n- max_total_sales_amount: L√≠mite total de monto (null = ilimitado)\n- max_users: M√°ximo de usuarios\n- max_branches: M√°ximo de sucursales\n\n**Tipos de plan:**\n- monthly: Mensual\n- yearly: Anual\n- lifetime: De por vida\n\n**cancel_previous:** Si es true, cancela suscripciones activas anteriores."
					},
					"response": []
				},
				{
					"name": "2.4 - Ver Suscripci√≥n Espec√≠fica",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"1"
							]
						},
						"description": "Obtiene informaci√≥n detallada de una suscripci√≥n espec√≠fica. Reemplaza '1' con el ID de la suscripci√≥n."
					},
					"response": []
				},
				{
					"name": "2.5 - Actualizar Suscripci√≥n (Solo Super Admin)",
					"request": {
						"method": "PUT",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"plan_name\": \"enterprise\",\n    \"max_total_documents\": 100000,\n    \"max_total_sales_amount\": 5000000.00,\n    \"max_users\": 10,\n    \"status\": \"active\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"1"
							]
						},
						"description": "Actualiza una suscripci√≥n existente. Solo super administradores pueden actualizar suscripciones."
					},
					"response": []
				},
				{
					"name": "2.6 - Activar Suscripci√≥n (Solo Super Admin)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/1/activate",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"1",
								"activate"
							]
						},
						"description": "Activa una suscripci√≥n. Solo super administradores pueden activar suscripciones."
					},
					"response": []
				},
				{
					"name": "2.7 - Cancelar Suscripci√≥n (Solo Super Admin)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/1/cancel",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"1",
								"cancel"
							]
						},
						"description": "Cancela una suscripci√≥n. Solo super administradores pueden cancelar suscripciones."
					},
					"response": []
				},
				{
					"name": "2.8 - Renovar Suscripci√≥n (Solo Super Admin)",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"months\": 1\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/1/renew",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"1",
								"renew"
							]
						},
						"description": "Renueva una suscripci√≥n agregando meses adicionales. Solo super administradores pueden renovar suscripciones.\n\n**Par√°metros:**\n- months: N√∫mero de meses a agregar (1-12)"
					},
					"response": []
				}
			],
			"description": "Gesti√≥n completa de suscripciones/licencias por empresa. Las suscripciones controlan el acceso al API y los l√≠mites de uso."
		},
		{
			"name": "EJEMPLOS DE USO CON TOKEN DE EMPRESA",
			"item": [
				{
					"name": "3.1 - Crear Factura con Token de Empresa",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{company_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"company_id\": {{company_id}},\n    \"branch_id\": 1,\n    \"client\": {\n        \"tipo_documento\": \"6\",\n        \"numero_documento\": \"20100070970\",\n        \"razon_social\": \"CLIENTE PRUEBA SAC\",\n        \"direccion\": \"AV. PRINCIPAL 123\"\n    },\n    \"serie\": \"F001\",\n    \"fecha_emision\": \"2025-01-15\",\n    \"moneda\": \"PEN\",\n    \"detalles\": [\n        {\n            \"codigo\": \"PROD001\",\n            \"descripcion\": \"Producto de prueba\",\n            \"cantidad\": 1,\n            \"unidad_medida\": \"NIU\",\n            \"precio_unitario\": 100.00,\n            \"tipo_igv\": \"10\",\n            \"igv\": 18.00,\n            \"precio_total\": 118.00\n        }\n    ]\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/invoices",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"invoices"
							]
						},
						"description": "Ejemplo de creaci√≥n de factura usando token de empresa. El sistema verificar√° autom√°ticamente los l√≠mites de suscripci√≥n antes de crear el documento.\n\n**Nota:** Si se alcanza un l√≠mite, recibir√°s un error con informaci√≥n detallada de los l√≠mites restantes."
					},
					"response": []
				},
				{
					"name": "3.2 - Crear Boleta con Token de Empresa",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{company_token}}"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"company_id\": {{company_id}},\n    \"branch_id\": 1,\n    \"client\": {\n        \"tipo_documento\": \"1\",\n        \"numero_documento\": \"12345678\",\n        \"nombre\": \"Juan P√©rez\",\n        \"direccion\": \"AV. PRINCIPAL 456\"\n    },\n    \"serie\": \"B001\",\n    \"fecha_emision\": \"2025-01-15\",\n    \"moneda\": \"PEN\",\n    \"detalles\": [\n        {\n            \"codigo\": \"PROD002\",\n            \"descripcion\": \"Producto de prueba\",\n            \"cantidad\": 2,\n            \"unidad_medida\": \"NIU\",\n            \"precio_unitario\": 50.00,\n            \"tipo_igv\": \"10\",\n            \"igv\": 18.00,\n            \"precio_total\": 118.00\n        }\n    ]\n}"
						},
						"url": {
							"raw": "{{base_url}}/v1/boletas",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"boletas"
							]
						},
						"description": "Ejemplo de creaci√≥n de boleta usando token de empresa. El sistema verificar√° autom√°ticamente los l√≠mites de suscripci√≥n."
					},
					"response": []
				}
			],
			"description": "Ejemplos pr√°cticos de c√≥mo usar tokens de empresa para consumir el API directamente desde otras aplicaciones."
		},
		{
			"name": "VERIFICACI√ìN DE L√çMITES",
			"item": [
				{
					"name": "4.1 - Ver L√≠mites de Suscripci√≥n Activa",
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Accept",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{user_token}}"
							}
						],
						"url": {
							"raw": "{{base_url}}/v1/companies/{{company_id}}/subscriptions/active",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"v1",
								"companies",
								"{{company_id}}",
								"subscriptions",
								"active"
							]
						},
						"description": "Obtiene informaci√≥n sobre los l√≠mites actuales de la suscripci√≥n activa, incluyendo:\n- Documentos restantes (mensual y total)\n- Monto restante de ventas\n- Estado de la suscripci√≥n\n\n**Respuesta incluye:**\n- max_total_documents: L√≠mite total configurado\n- total_documents_created: Documentos ya creados\n- remaining_documents: Documentos restantes\n- max_total_sales_amount: L√≠mite de monto configurado\n- total_sales_amount: Monto ya utilizado\n- remaining_sales_amount: Monto restante"
					},
					"response": []
				}
			],
			"description": "Endpoints para verificar el estado de los l√≠mites de suscripci√≥n antes de crear documentos."
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:8000/api",
			"type": "string",
			"description": {
				"content": "URL base del API - Compartida con otras colecciones",
				"type": "text/plain"
			}
		},
		{
			"key": "company_id",
			"value": "",
			"type": "string",
			"description": {
				"content": "ID de empresa - Compartida con otras colecciones",
				"type": "text/plain"
			}
		},
		{
			"key": "user_token",
			"value": "",
			"type": "string",
			"description": {
				"content": "Token de usuario (Sanctum) - Compartido con otras colecciones. Se obtiene con /auth/login. Tambi√©n puede usar 'access_token'.",
				"type": "text/plain"
			}
		},
		{
			"key": "access_token",
			"value": "",
			"type": "string",
			"description": {
				"content": "Token de acceso de usuario - Alias de user_token. Compartido con otras colecciones.",
				"type": "text/plain"
			}
		},
		{
			"key": "company_token",
			"value": "",
			"type": "string",
			"description": {
				"content": "Token de API de la empresa - Compartido con otras colecciones. Se obtiene al crear un token o autom√°ticamente al crear la empresa.",
				"type": "text/plain"
			}
		}
	]
}

